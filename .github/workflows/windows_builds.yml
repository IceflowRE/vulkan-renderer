name: Windows Builds

on:
  workflow_call:
    inputs:
      vulkan-sdk-version:
        type: string
        required: true
      vulkan-sdk-checksum:
        type: string
        required: true

jobs:
  windows:
    name: ${{ matrix.config.name }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        config:
          - name: "Windows MSVC (Debug)"
            cmake-preset: "windows-msvc"
            extra_cmake_args: "--config Debug"
            artifacts-id: "msvc_debug"
          - name: "Windows MSVC (Release)"
            cmake-preset: "windows-msvc"
            extra_cmake_args: "--config Release"
            artifacts-id: "msvc_release"
          - name: "Windows Clang (Debug)"
            cmake-preset: "windows-clang-debug"
            artifacts-id: "clang_debug"
          - name: "Windows Clang (Release)"
            cmake-preset: "windows-clang-release"
            artifacts-id: "clang_release"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Setup System
        uses: ./.github/actions/setup-windows
        with:
          vulkan-sdk-version: ${{ inputs.vulkan-sdk-version }}
          vulkan-sdk-checksum: ${{ inputs.vulkan-sdk-checksum }}

      - name: Load CMake Cache
        id: cache-cmake
        uses: ./.github/actions/cmake-cache
        with:
          key: ${{ matrix.config.cmake-preset }}

      - name: Configure CMake
        if: steps.cache-cmake.outputs.cache-hit != 'true'
        run: |
          cmake . --preset ${{ matrix.config.cmake-preset }} -Bbuild

      - name: Build Core
        run: cmake --build build --target inexor-vulkan-renderer-core-lib --parallel ${{ matrix.config.extra_cmake_args }}

      - name: Build Example
        run: cmake --build build --target inexor-vulkan-renderer-example --parallel ${{ matrix.config.extra_cmake_args }}

      - name: Build Tests
        run: cmake --build build --target inexor-vulkan-renderer-tests --parallel ${{ matrix.config.extra_cmake_args }}

      - name: Build Benchmarks
        run: cmake --build build --target inexor-vulkan-renderer-benchmarks --parallel ${{ matrix.config.extra_cmake_args }}

      - name: Run Tests
        working-directory: build
        run: |
          Get-ChildItem -Recurse -Filter '*-tests.exe' | ForEach-Object {
            Write-Host "Running $($_.FullName)"
            & $_.FullName --gtest_output=xml:"$($_.FullName).xml"
          }

      - name: Run Benchmarks
        working-directory: build
        run: |
          if (Test-Path benchmark) { Remove-Item benchmark -Recurse -Force }
          mkdir benchmark
          Get-ChildItem -Recurse -Filter '*-benchmarks.exe' | ForEach-Object {
            $benchPath = $_.FullName
            $outputFile = Join-Path -Path "benchmark" -ChildPath "$($_.BaseName).txt"
            Write-Host "Running $benchPath"
            & $benchPath 2>&1 | Tee-Object -FilePath $outputFile
          }

      - name: Set Build Version
        uses: ./.github/actions/set-build-version

      - name: Prepare Artifacts
        shell: pwsh
        run: |
          $base = "${{ matrix.config.artifacts_id }}-${{ env.BUILD_VERSION }}"

          # Core
          mkdir "windows-core-$base"
          Get-ChildItem -Path ./build -Recurse -Filter "inexor-vulkan-renderer-core-lib*" |
            ForEach-Object { Copy-Item $_.FullName "windows-core-$base" }

          # Example
          mkdir "windows-example-$base"
          Get-ChildItem -Path ./build -Recurse -Filter "inexor-vulkan-renderer-example.exe" |
            ForEach-Object { Copy-Item $_.FullName "windows-example-$base" }

          Copy-Item -Path ./assets/. -Destination "windows-example-$base" -Recurse
          mkdir "windows-example-$base/shaders"
          Copy-Item -Path ./shaders/*.spv -Destination "windows-example-$base/shaders"

          # Benchmarks, Tests
          mkdir "windows-benchmarks-tests-$base"
          Get-ChildItem -Path ./build -Recurse -Filter "*-tests.exe" |
            ForEach-Object { Copy-Item $_.FullName "windows-benchmarks-tests-$base" }

          Get-ChildItem -Path ./build -Recurse -Filter "*.xml" |
            ForEach-Object { Copy-Item $_.FullName "windows-benchmarks-tests-$base" }

          Get-ChildItem -Path ./build -Recurse -Filter "*-benchmarks.exe" |
            ForEach-Object { Copy-Item $_.FullName "windows-benchmarks-tests-$base" }

          if (Test-Path ./build/benchmark) {
            Copy-Item -Path ./build/benchmark -Destination "windows-benchmarks-tests-$base" -Recurse
          }

      - name: Upload Artifacts
        uses: actions/upload-artifact@v6
        with:
          path: |
            windows-core-${{ matrix.config.artifacts_id }}-${{ env.BUILD_VERSION }}
            windows-example-${{ matrix.config.artifacts_id }}-${{ env.BUILD_VERSION }}
            windows-benchmarks-tests-${{ matrix.config.artifacts_id }}-${{ env.BUILD_VERSION }}
          retention-days: 14
