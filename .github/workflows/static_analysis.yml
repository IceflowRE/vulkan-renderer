name: Static Code Analysis

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

env:
  INEXOR_VULKAN_SDK_VERSION: "1.3.283.0"
  INEXOR_VULKAN_SDK_CHECKSUM_LINUX: "8005e2cf3e89c80cbe1c0d0a259c88248de3257b4fc6fdefb47409edb3e43ecb"
  INEXOR_VULKAN_SDK_CHECKSUM_WINDOWS: "811fcb9b43d09248520b2f38ae9a3763fc81df950fdab874f23bd762b07a9b12"
  INEXOR_VULKAN_SDK_PATH: "${{ github.workspace }}/vulkan_sdk"

# Cancel CI workflows which are still running from previous pushes
concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  clang-tidy:
    name: Clang-Tidy
    runs-on: ubuntu-latest
    env:
      INEXOR_CMAKE_PRESET: "linux-clang-debug"
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup System
        uses: ./.github/actions/linux-setup
        with:
          vulkan-sdk-version: ${{ env.INEXOR_VULKAN_SDK_VERSION }}
          vulkan-sdk-checksum: ${{ env.INEXOR_VULKAN_SDK_CHECKSUM_LINUX }}
          vulkan-sdk-path: ${{ env.INEXOR_VULKAN_SDK_PATH }}

      - name: Set build version
        uses: ./.github/actions/set-build-version

      - name: Load CMake Cache
        id: cache-cmake
        uses: ./.github/actions/cmake-cache
        with:
          key: ${{ env.INEXOR_CMAKE_PRESET }}

      - name: Configure CMake
        if: steps.cache-cmake.outputs.cache-hit != 'true'
        run: |
          cmake . --preset ${{ env.INEXOR_CMAKE_PRESET }} -Bbuild

      - name: Check the files found for clang-tidy
        run: |
          find example-app src include \
            -path '*/_deps/*' -prune -o \
            -path '*/build/*' -prune -o \
            \( -name '*.cpp' -o -name '*.hpp' \) -print

      - name: Run clang-tidy
        run: |
          find example-app src include \
            -path '*/_deps/*' -prune -o \
            -path '*/build/*' -prune -o \
            \( -name '*.cpp' -o -name '*.hpp' \) -print0 |
            parallel -0 clang-tidy -p build {} |
            tee static_analysis-clang_tidy.txt || true

      - name: Summarize clang-tidy warnings
        run: |
          grep -hEo '\[[a-z0-9]+-[a-z0-9-]+\]' static_analysis-clang_tidy.txt \
            | sort | uniq -c | sort -nr \
            | sed 's/[][]//g' || true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: nightly-linux_static_analysis_clang_tidy-${{ env.BUILD_VERSION }}
          path: static_analysis-clang_tidy.txt

  scan-build:
    name: scan-build
    runs-on: ubuntu-latest
    env:
      INEXOR_CMAKE_PRESET: "linux-clang-debug"
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup System
        uses: ./.github/actions/linux-setup
        with:
          vulkan-sdk-version: ${{ env.INEXOR_VULKAN_SDK_VERSION }}
          vulkan-sdk-checksum: ${{ env.INEXOR_VULKAN_SDK_CHECKSUM_LINUX }}
          vulkan-sdk-path: ${{ env.INEXOR_VULKAN_SDK_PATH }}

      - name: Set build version
        uses: ./.github/actions/set-build-version

      - name: Load CMake Cache
        id: cache-cmake
        uses: ./.github/actions/cmake-cache
        with:
          key: ${{ env.INEXOR_CMAKE_PRESET }}

      - name: Configure CMake
        if: steps.cache-cmake.outputs.cache-hit != 'true'
        run: |
          cmake . --preset ${{ env.INEXOR_CMAKE_PRESET }} -Bbuild

      - name: Run scan-build
        run: |
          mkdir -p static_analysis-scan_build_report
          scan-build-18 \
            -o static_analysis-scan_build_report \
            cmake --build build -- -j$(nproc) 2>&1 | tee static_analysis-scan_build_summary.txt

      - name: Upload Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: nightly-linux_static_analysis_scan_build-${{ env.BUILD_VERSION }}
          path: |
            static_analysis-scan_build_report
            static_analysis-scan_build_summary.txt

  cppcheck:
    name: Cppcheck
    runs-on: ubuntu-latest
    env:
      INEXOR_CMAKE_PRESET: "linux-clang-debug"
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup System
        uses: ./.github/actions/linux-setup
        with:
          vulkan-sdk-version: ${{ env.INEXOR_VULKAN_SDK_VERSION }}
          vulkan-sdk-checksum: ${{ env.INEXOR_VULKAN_SDK_CHECKSUM_LINUX }}
          vulkan-sdk-path: ${{ env.INEXOR_VULKAN_SDK_PATH }}

      - name: Set build version
        uses: ./.github/actions/set-build-version

      - name: Install Cppcheck
        run: |
          sudo apt update -qq
          sudo apt-get install -y \
            cppcheck

      - name: Load CMake Cache
        id: cache-cmake
        uses: ./.github/actions/cmake-cache
        with:
          key: ${{ env.INEXOR_CMAKE_PRESET }}

      - name: Configure CMake
        if: steps.cache-cmake.outputs.cache-hit != 'true'
        run: |
          cmake . --preset ${{ env.INEXOR_CMAKE_PRESET }} -Bbuild

      - name: Find source files for cppcheck
        id: find_sources
        run: |
          find example-app src include \
            -path '*/_deps/*' -prune -o \
            -path '*/build/*' -prune -o \
            \( -name '*.cpp' -o -name '*.hpp' \) -print > source_files.txt
          cat source_files.txt

      - name: Run cppcheck on source_files.txt
        run: |
          # Use xargs to run cppcheck on all files listed in source_files.txt
          xargs -a source_files.txt cppcheck \
            --enable=all \
            --inconclusive \
            --force \
            --suppress=missingIncludeSystem \
            --inline-suppr \
            2> static_analysis-cppcheck_output.txt || true

      - name: Summarize cppcheck warnings
        run: |
          cat static_analysis-cppcheck_output.txt | sort | uniq -c | sort -nr || true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: nightly-linux_static_analysis_cppcheck-${{ env.BUILD_VERSION }}
          path: static_analysis-cppcheck_output.txt

  msvc-analysis:
    name: MSVC Analysis ${{ matrix.config.name }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        config:
          - name: "Debug"
            cmake_preset: "windows-msvc"
            build_type: "Debug"
            artifacts_id: "debug"
          - name: "Release"
            cmake_preset: "windows-msvc"
            build_type: "Release"
            artifacts_id: "release"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Setup System
        uses: ./.github/actions/windows-setup
        with:
          vulkan-sdk-version: ${{ env.INEXOR_VULKAN_SDK_VERSION }}
          vulkan-sdk-checksum: ${{ env.INEXOR_VULKAN_SDK_CHECKSUM_WINDOWS }}
          vulkan-sdk-path: ${{ env.INEXOR_VULKAN_SDK_PATH }}

      - name: Set build version
        uses: ./.github/actions/set-build-version

      - name: Load CMake Cache
        id: cache-cmake
        uses: ./.github/actions/cmake-cache
        with:
          key: ${{ matrix.config.cmake_preset }}_analyze

      - name: Configure CMake
        if: steps.cache-cmake.outputs.cache-hit != 'true'
        run: |
          cmake . --preset ${{ matrix.config.cmake_preset }} -Bbuild -DCMAKE_CXX_FLAGS=/analyze

      - name: Run MSVC Static Code Analysis
        run: |
          cmake --build build --target inexor-vulkan-renderer-core-lib --config ${{ matrix.config.build_type }} > msvc_analysis-${{ matrix.config.artifacts_id }}.txt 2>&1 || true
          cmake --build build --target inexor-vulkan-renderer-example --config ${{ matrix.config.build_type }} >> msvc_analysis-${{ matrix.config.artifacts_id }} 2>&1 || true
          cmake --build build --target inexor-vulkan-renderer-tests --config ${{ matrix.config.build_type }} >> msvc_analysis-${{ matrix.config.artifacts_id }} 2>&1 || true
          cmake --build build --target inexor-vulkan-renderer-benchmarks --config ${{ matrix.config.build_type }} >> msvc_analysis-${{ matrix.config.artifacts_id }} 2>&1 || true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: nightly-windows_static_analysis_msvc_analysis-${{ matrix.config.artifacts_id }}_${{ env.BUILD_VERSION}}
          path: msvc_analysis-${{ matrix.config.artifacts_id }}
          retention-days: 60
