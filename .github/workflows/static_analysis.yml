name: Static Code Analysis

on:
  workflow_call:
    inputs:
      vulkan-sdk-version:
        type: string
        required: true
      vulkan-sdk-checksum-linux:
        type: string
        required: true
      vulkan-sdk-checksum-windows:
        type: string
        required: true

jobs:
  clang-tidy:
    name: Clang-Tidy
    runs-on: ubuntu-latest
    env:
      INEXOR_CMAKE_PRESET: "linux-clang-debug"
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup System
        uses: ./.github/actions/setup-linux
        with:
          vulkan-sdk-version: ${{ inputs.vulkan-sdk-version }}
          vulkan-sdk-checksum: ${{ inputs.vulkan-sdk-checksum-linux }}

      - name: Load CMake Cache
        id: cache-cmake
        uses: ./.github/actions/cmake-cache
        with:
          key: ${{ env.INEXOR_CMAKE_PRESET }}

      - name: Configure CMake
        if: steps.cache-cmake.outputs.cache-hit != 'true'
        run: |
          cmake . --preset ${{ env.INEXOR_CMAKE_PRESET }} -Bbuild

      - name: Check the files found for clang-tidy
        run: |
          find example-app src include \
            -path '*/_deps/*' -prune -o \
            -path '*/build/*' -prune -o \
            \( -name '*.cpp' -o -name '*.hpp' \) -print

      - name: Run clang-tidy
        run: |
          find example-app src include \
            -path '*/_deps/*' -prune -o \
            -path '*/build/*' -prune -o \
            \( -name '*.cpp' -o -name '*.hpp' \) -print0 |
            parallel -0 clang-tidy -p build {} |
            tee static_analysis-clang_tidy.txt || true

      - name: Summarize clang-tidy warnings
        run: |
          grep -hEo '\[[a-z0-9]+-[a-z0-9-]+\]' static_analysis-clang_tidy.txt \
            | sort | uniq -c | sort -nr \
            | sed 's/[][]//g' || true

      - name: Set Build Version
        uses: ./.github/actions/set-build-version

      - name: Upload Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: static_analysis-clang_tidy-${{ env.BUILD_VERSION }}
          path: static_analysis-clang_tidy.txt
          retention-days: 14

  scan-build:
    name: scan-build
    runs-on: ubuntu-latest
    env:
      INEXOR_CMAKE_PRESET: "linux-clang-debug"
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup System
        uses: ./.github/actions/setup-linux
        with:
          vulkan-sdk-version: ${{ inputs.vulkan-sdk-version }}
          vulkan-sdk-checksum: ${{ inputs.vulkan-sdk-checksum-linux }}

      - name: Load CMake Cache
        id: cache-cmake
        uses: ./.github/actions/cmake-cache
        with:
          key: ${{ env.INEXOR_CMAKE_PRESET }}

      - name: Configure CMake
        if: steps.cache-cmake.outputs.cache-hit != 'true'
        run: |
          cmake . --preset ${{ env.INEXOR_CMAKE_PRESET }} -Bbuild

      - name: Run scan-build
        run: |
          mkdir -p static_analysis-scan_build_report
          scan-build-18 \
            -o static_analysis-scan_build_report \
            cmake --build build -- -j$(nproc) 2>&1 | tee static_analysis-scan_build_summary.txt

      - name: Set Build Version
        uses: ./.github/actions/set-build-version

      - name: Upload Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: static_analysis-scan_build-${{ env.BUILD_VERSION }}
          path: |
            static_analysis-scan_build_report
            static_analysis-scan_build_summary.txt
          retention-days: 14

  cppcheck:
    name: Cppcheck
    runs-on: ubuntu-latest
    env:
      INEXOR_CMAKE_PRESET: "linux-clang-debug"
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup System
        uses: ./.github/actions/setup-linux
        with:
          vulkan-sdk-version: ${{ inputs.vulkan-sdk-version }}
          vulkan-sdk-checksum: ${{ inputs.vulkan-sdk-checksum-linux }}

      - name: Install Cppcheck
        run: |
          sudo apt update -qq
          sudo apt-get install -y \
            cppcheck

      - name: Load CMake Cache
        id: cache-cmake
        uses: ./.github/actions/cmake-cache
        with:
          key: ${{ env.INEXOR_CMAKE_PRESET }}

      - name: Configure CMake
        if: steps.cache-cmake.outputs.cache-hit != 'true'
        run: |
          cmake . --preset ${{ env.INEXOR_CMAKE_PRESET }} -Bbuild

      - name: Find source files for cppcheck
        id: find_sources
        run: |
          find example-app src include \
            -path '*/_deps/*' -prune -o \
            -path '*/build/*' -prune -o \
            \( -name '*.cpp' -o -name '*.hpp' \) -print > source_files.txt
          cat source_files.txt

      - name: Run Cppcheck on source_files.txt
        run: |
          # Use xargs to run cppcheck on all files listed in source_files.txt
          xargs -a source_files.txt cppcheck \
            --enable=all \
            --inconclusive \
            --force \
            --suppress=missingIncludeSystem \
            --inline-suppr \
            2> static_analysis-cppcheck_output.txt || true

      - name: Summarize cppcheck warnings
        run: |
          cat static_analysis-cppcheck_output.txt | sort | uniq -c | sort -nr || true

      - name: Set Build Version
        uses: ./.github/actions/set-build-version

      - name: Upload Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: static_analysis_cppcheck-${{ env.BUILD_VERSION }}
          path: static_analysis-cppcheck_output.txt
          retention-days: 14

  msvc-analysis:
    name: MSVC Analysis ${{ matrix.config.name }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        config:
          - name: "Debug"
            cmake_preset: "windows-msvc"
            build_type: "Debug"
            artifacts_id: "debug"
          - name: "Release"
            cmake_preset: "windows-msvc"
            build_type: "Release"
            artifacts_id: "release"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Setup System
        uses: ./.github/actions/setup-windows
        with:
          vulkan-sdk-version: ${{ inputs.vulkan-sdk-version }}
          vulkan-sdk-checksum: ${{ inputs.vulkan-sdk-checksum-windows }}

      - name: Load CMake Cache
        id: cache-cmake
        uses: ./.github/actions/cmake-cache
        with:
          key: ${{ matrix.config.cmake_preset }}_analyze

      - name: Configure CMake
        if: steps.cache-cmake.outputs.cache-hit != 'true'
        run: |
          cmake . --preset ${{ matrix.config.cmake_preset }} -Bbuild -DCMAKE_CXX_FLAGS=/analyze

      - name: Analyse Core
        run: cmake --build build --target inexor-vulkan-renderer-core-lib --config ${{ matrix.config.build_type }} > msvc_analysis-${{ matrix.config.artifacts_id }}.txt 2>&1 || true
      
      - name: Analyse Example
        run: cmake --build build --target inexor-vulkan-renderer-example --config ${{ matrix.config.build_type }} >> msvc_analysis-${{ matrix.config.artifacts_id }}.txt 2>&1 || true
      
      - name: Analyse Tests
        run: cmake --build build --target inexor-vulkan-renderer-tests --config ${{ matrix.config.build_type }} >> msvc_analysis-${{ matrix.config.artifacts_id }}.txt 2>&1 || true
      
      - name: Analyse Benchmarks
        run: cmake --build build --target inexor-vulkan-renderer-benchmarks --config ${{ matrix.config.build_type }} >> msvc_analysis-${{ matrix.config.artifacts_id }}.txt 2>&1 || true

      - name: Set Build Version
        uses: ./.github/actions/set-build-version

      - name: Upload Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: static_analysis-msvc_analysis_${{ matrix.config.artifacts_id }}-${{ env.BUILD_VERSION}}
          path: msvc_analysis-${{ matrix.config.artifacts_id }}.txt
          retention-days: 14
